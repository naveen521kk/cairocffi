name: Build Wheels

on:
  push:


jobs:
  build_wheels:
    name: Build wheels for Windows on ${{ matrix.python-version }}
    runs-on: windows-latest
    env:
      CAIRO_VERSION: "1.17.2"
      TOKENACCESS: ${{ secrets.GITHUB_TOKEN }} 
    strategy:
      matrix:
        python-version: [3.5, 3.6, 3.7, 3.8]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel
    - name: Download Cairo
      run: |
        curl -L https://github.com/preshing/cairo-windows/releases/download/with-tee/cairo-windows-1.17.2.zip -o cairo-windows.zip
        7z x cairo-windows.zip
        Move-Item 'cairo-windows-*' "cairocomplied"
        Copy-Item "$PWD\cairocomplied\lib\x64\cairo.dll" "cairocffi\libcairo-2.dll"
        Rename-Item -Path "$PWD\cairocomplied\lib\x64\cairo.dll" -NewName "libcairo-2.dll"
        Rename-Item -Path "$PWD\cairocomplied\lib\x86\cairo.dll" -NewName "libcairo-2.dll"

    - name: Test
      run: |
        $env:INCLUDE="$PWD\cairocomplied\include\"
        $env:LIB="$PWD\cairocomplied\lib\x64\"
        python setup.py install
        python setup.py bdist_wheel
    - name: Set up Python ${{ matrix.python-version }} for x86
      uses: actions/setup-python@v2
      with:
          python-version: ${{ matrix.python-version }}
          architecture: 'x86'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel
    - name: Build x86 Build
      run: |
          $env:INCLUDE="$PWD\cairocomplied\include\"
          $env:LIB="$PWD\cairocomplied\lib\x86\"
          python setup.py install
          python setup.py bdist_wheel
    - uses: actions/upload-artifact@v2
      with:
         name: wheels-${{ matrix.python-version }}
         path: dist/*.whl   
